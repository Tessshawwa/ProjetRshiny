---
title: 'Analyse Comparative des DPE : Nord (59) vs. Sud (66)'
author: |
  <div>
    <img src="greentech_logo.png" alt="GreenTech Logo" style="height:50px; vertical-align: middle; margin: 10px;">
    <img src="Logo_enedis.png" alt="Logo Enedis" style="height:50px; vertical-align: middle; margin: 10px;">
  <div style="margin-top: 20px;">
    Rapport préparé par : V. GROSJEAN & T. ALSHAWWA
date: "`r format(Sys.Date(), '%d %B %Y')`"
output:
  pdf_document:
    toc: true
  html_document:
    toc: true
    toc_float: true
    number_sections: false
    theme: cerulean
    code_folding: hide
params:
  code_postal:
    label: 'Choisir le Département :'
    value: Tous
    input: select
    choices:
    - Tous
    - '59'
    - '66'
---

<style type="text/css">
/* --- 1. Police principale (Times New Roman) --- */
body {
  font-family: "Times New Roman", Times, serif;
  font-size: 1.1em;
}

/* --- 2. Centrer le bloc de titre --- */
#header {
  text-align: center;
}

/* --- 3. Style du Titre Principal (Rouge, Gras, Times) --- */
#header h1 {
  font-family: "Times New Roman", Times, serif; /* Police changée */
  font-weight: bold;           /* En gras */
  color: #c00000;             /* Rouge foncé */
  font-size: 3.5em;            /* Plus grand */
}

/* --- 4. Style des Titres de Section (H1, H2) --- */
h1, h2 {
  font-weight: bold;
}
h2 { /* NOUVELLE RÈGLE */
  color: black !important; /* Force le H2 (Titre 2) en noir */
}

/* --- 5. Titre pour le Sommaire (Times) --- */
#TOC::before {
  content: "Sommaire";         /* Le texte du titre */
  font-family: "Times New Roman", Times, serif; /* Police changée */
  font-weight: bold;           /* En gras */
  font-size: 1.5em;            /* Taille du titre */
  color: #c00000;             /* Couleur rouge (comme le titre principal) */
  display: block;              /* Pour qu'il soit sur sa propre ligne */
  text-align: center;          /* Centré */
  margin-bottom: 15px;         /* Espace avant la liste */
}

/* --- 6. Style pour la ligne "Auteur" avec les logos --- */
#header p {
  font-size: 1.1em; /* Ajuster la taille de la ligne auteur */
  margin-top: 25px; /* Ajouter de l'espace sous le titre */
}
</style>

```{r setup, include=FALSE}
# Configuration globale du document
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
library(dplyr)
library(ggplot2)
library(readr)
library(lubridate)
library(scales)
```

# Contexte de l'Analyse

Ce rapport, préparé par GreenTech Solutions, analyse les données de Diagnostics de Performance Énergétique (DPE) pour les logements dans deux départements français aux climats distincts : le Nord (59) et les Pyrénées-Orientales (66).

Les données proviennent de l'API publique de l'ADEME et couvrent l'ensemble des logements (neufs et existants), tous types de chauffage confondus.

En complément de ce rapport d'analyse statique, notre équipe GreenTech Solutions a développé une **application d'exploration interactive** (basée sur Shiny) pour permettre à Enedis d'explorer les données de manière dynamique et de cibler des zones ou des typologies de bâtiments spécifiques.

# Problématique et Méthodologie

## Problématique
La problématique de cette analyse est la suivante :

**"Comment les performances énergétiques des logements dans le Nord (Dép. 59) se comparent-elles à celles du Sud (Dép. 66), et quels facteurs (type de logement, type de chauffage, isolation) expliquent les différences observées ?"**

## Méthodologie
Pour répondre à cette question, notre analyse compare la distribution des étiquettes DPE entre les deux régions. 

1.  Ce Rapport Statique présente les conclusions principales et les analyses globales. Il est **"paramétré"**, ce qui offre deux niveaux d'utilisation :
    * **Service Inclus :** Sur simple demande, nous pouvons régénérer ce rapport pour n'importe quel périmètre (par exemple, uniquement pour le département 59).
    * **Mode "Client" :** Pour les utilisateurs à l'aise avec la technologie, le script R Markdown lui-même peut être exécuté pour appliquer des filtres. Les instructions sont détaillées à la fin, dans la section **Documentation Technique du Rapport**.
2.  L'Application Interactive sert d'outil de simulation et d'exploration pour Enedis. Elle permet de filtrer les données en temps réel et de visualiser l'impact de chaque variable.

---

# Périmètre et Indicateurs Clés

## Périmètre de l'Analyse
Le bloc de code suivant charge la totalité des données, applique le filtre départemental paramétré, puis calcule les indicateurs clés pour ce périmètre.

```{r calcul_et_kpi, echo=FALSE}
# 'echo = FALSE' pour cacher ce bloc technique.
fichier_data <- "L:/BUT/SD/Promo 2024/talshawwa/ProjetRshiny/ProjetRshiny/ExtractionDPENordSud/df_nord_sud_COMBINE_COMPLET.csv"
df_brut <- read_csv(fichier_data)

# 1. Application des paramètres choisis par l'utilisateur
df_filtre <- df_brut # Nous analysons TOUTES les données

if (params$code_postal != "Tous") {
  df_filtre <- df_filtre %>% filter(code_departement_ban == params$code_postal)
}

# 2. Préparation finale pour l'analyse
dpe_levels <- c("A", "B", "C", "D", "E", "F", "G") # Ordre correct

df_prepare <- df_filtre %>%
  mutate(etiquette_dpe = factor(etiquette_dpe, levels = dpe_levels, ordered = TRUE)) %>%
  mutate(departement = case_when(
    code_departement_ban == "59" ~ "59 - Nord",
    code_departement_ban == "66" ~ "66 - Pyrénées-Orientales",
    TRUE ~ as.character(code_departement_ban)
  )) %>%
  filter(!is.na(etiquette_dpe), !is.na(departement), !is.na(typologie_logement))
  
# 3. Calcul des KPI pour affichage
kpi_total <- format(nrow(df_prepare), big.mark = " ")
kpi_conso <- round(mean(df_prepare$conso_5_usages_par_m2_ep, na.rm = TRUE), 1)
kpi_passoires <- scales::percent(sum(df_prepare$etiquette_dpe %in% c("F", "G")) / nrow(df_prepare), accuracy = 0.1)
```

Voici les indicateurs clés (KPI) pour le périmètre sélectionné :
*(Périmètre : Département = `r params$code_postal`)*

* **Nombre total de logements analysés :** `r kpi_total`
* **Consommation moyenne (5 usages) :** `r kpi_conso` kWh/m²/an
* **Part des passoires (F et G) :** `r kpi_passoires`

---

# Analyse 1 : Comparaison de la Performance (Nord vs. Sud)

Ce graphique compare la structure du parc immobilier entre les deux départements. Il n'est affiché que si l'analyse porte sur les deux départements.

```{r plot_distribution_dpe, eval = (params$code_postal == "Tous")}
# Ce graphique ne s'affichera que si vous a sélectionné "Tous" les départements
ggplot(df_prepare, aes(x = etiquette_dpe, fill = departement)) +
  geom_bar(position = "fill") +
  scale_y_continuous(labels = scales::percent_format()) +
  scale_fill_manual(values = c("59 - Nord" = "#156077", "66 - Pyrénées-Orientales" = "#f28e2c")) +
  labs(
    title = "Distribution des Étiquettes DPE (Nord vs. Sud)",
    subtitle = "Comparaison en pourcentage de chaque parc immobilier",
    x = "Étiquette DPE",
    y = "Proportion",
    fill = "Département"
  ) +
  theme_minimal()
```

```{r analyse_1_text, eval = (params$code_postal == "Tous"), results='asis'}
cat("## Analyse du Graphique 1\n\n")
cat("**Observation :** L'analyse comparative révèle un déséquilibre majeur. Le **59 - Nord** (en bleu) présente une part alarmante de logements classés D, E, et F.\n\n")
cat("**Analyse :** Le **66 - Pyrénées-Orientales** (en orange) montre un parc beaucoup plus performant, avec une majorité de logements en classe B et C. Surtout, la part des passoires (F et G) est proportionnellement bien plus faible dans le Sud que dans le Nord.\n\n")
cat("**Conclusion :** Le climat et l'âge du parc immobilier ont un impact direct. Le parc du Nord est globalement moins performant et représente un enjeu de rénovation énergétique plus important.\n")
```

---

# Analyse 2 : Impact du Type de Logement (Neuf vs. Existant)

Ce graphique sépare les logements neufs des logements existants pour voir d'où vient la différence observée.

```{r plot_par_typologie}
# Ce graphique utilise facet_wrap, il est pertinent quel que soit le filtre
ggplot(df_prepare, aes(x = etiquette_dpe, fill = typologie_logement)) +
  geom_bar() +
  facet_wrap(~ departement, scales = "free_y") + # Un graphique pour chaque département
  scale_fill_manual(values = c("existant" = "#B0B0B0", "neuf" = "#1F78B4")) +
  labs(
    title = "Distribution DPE par Type de Logement (Neuf vs. Existant)",
    subtitle = "Répartition par département (nombre de logements)",
    x = "Étiquette DPE",
    y = "Nombre de Logements",
    fill = "Typologie"
  ) +
  theme_minimal()
```

## Analyse du Graphique 2

**Observation :** Ce graphique est très révélateur. On constate que la quasi-totalité des logements neufs (en bleu foncé) sont classés A, B ou C, et ce, dans les deux départements.

**Analyse :** Les logements existants (en gris) constituent la grande majorité du parc, et ce sont eux qui possèdent la quasi-totalité des "passoires thermiques" (F et G).

**Conclusion :** La différence de performance globale entre le Nord et le Sud (vue au graphique 1) ne provient pas des logements neufs (qui sont performants partout grâce aux normes de construction), mais bien de la performance médiocre du parc de logements existants dans le Nord.

---

# Analyse 3 : Systèmes de Chauffage

Ce graphique en secteurs identifie la part de marché des énergies de chauffage les plus utilisées dans le périmètre sélectionné.

```{r plot_energie_pie, warning=FALSE}
# Préparation des données :
# on a regroupé les "petites" catégories en "Autre" pour plus de lisibilité
df_pie_data <- df_prepare %>%
  filter(!is.na(type_energie_principale_chauffage) & type_energie_principale_chauffage != "") %>%
  count(type_energie_principale_chauffage) %>%
  mutate(proportion = n / sum(n)) %>%
  # Regrouper tout ce qui est sous 5% en "Autre"
  mutate(energie = ifelse(proportion < 0.05, "Autre", type_energie_principale_chauffage)) %>%
  group_by(energie) %>%
  summarise(n = sum(n)) %>%
  mutate(proportion = n / sum(n),
         label_text = scales::percent(proportion, accuracy=1))

ggplot(df_pie_data, aes(x = "", y = proportion, fill = energie)) +
  geom_bar(stat = "identity", width = 1) +
  coord_polar("y", start = 0) + # pour créer le pie chart
  geom_text(aes(label = label_text), 
            position = position_stack(vjust = 0.5), 
            color = "white", fontface = "bold") +
  labs(
    title = "Part des Énergies de Chauffage Principales",
    subtitle = paste("Périmètre : Département", params$code_postal),
    fill = "Énergie"
  ) +
  theme_void() + # Thème vide pour les pie charts
  theme(plot.title = element_text(hjust = 0.5, face="bold"),
        plot.subtitle = element_text(hjust = 0.5))
```

## Analyse du Graphique 3

```{r analyse_3_text, results='asis'}
# Cette analyse est dynamique
cat("**Observation :** Pour le périmètre sélectionné, ce graphique montre les parts de marché des différentes sources d'énergie de chauffage.\n\n")

if (params$code_postal == "Tous") {
  cat("**Analyse (Globale) :** Sur l'ensemble de notre échantillon, c'est **l'Électricité** qui est l'énergie dominante (environ 49% des logements). Elle est suivie par le **Gaz** (environ 39%). Les autres énergies (Fioul, Bois, etc.) représentent une part plus faible.\n")
} else if (params$code_postal == "59") {
  cat("**Analyse (Nord) :** Dans le Nord, le **Gaz** domine très largement (50% du parc), ce qui est cohérent avec l'urbanisation et l'historique du réseau de gaz de ville. L'électricité arrive en seconde position.\n")
} else if (params$code_postal == "66") {
  cat("**Analyse (Sud) :** Dans les Pyrénées-Orientales, la situation est inversée : **l'Électricité** est l'énergie de chauffage la plus répandue (plus de 60%), dépassant largement le Gaz. Cela peut être dû à un climat plus doux et à un parc de logements plus récent.\n")
}
```

---

# Analyse 4 : Qualité de l'Isolation

Qu'est-ce qui explique ces mauvaises notes ? Cette analyse croise la classe DPE avec la qualité déclarée de l'isolation des murs.

```{r plot_isolation}
# Nous filtrons les DPE "blancs" ou inconnus pour l'isolation
df_plot_iso <- df_prepare %>%
  filter(qualite_isolation_murs %in% c("bonne", "moyenne", "insuffisante", "très bonne")) %>%
  # Ordonner les niveaux pour la légende
  mutate(qualite_isolation_murs = factor(qualite_isolation_murs, 
                                         levels = c("très bonne", "bonne", "moyenne", "insuffisante"))) %>%
  count(etiquette_dpe, qualite_isolation_murs) %>%
  group_by(etiquette_dpe) %>%
  mutate(proportion = n / sum(n)) %>%
  ungroup()

ggplot(df_plot_iso, aes(x = etiquette_dpe, y = proportion, fill = qualite_isolation_murs)) +
  geom_bar(stat = "identity", position = "fill") +
  scale_y_continuous(labels = scales::percent_format()) +
  scale_fill_manual(
    values = c("très bonne" = "#006837", "bonne" = "#4E9D52", "moyenne" = "#E7B800", "insuffisante" = "#DB4444"),
    name = "Isolation Murs"
  ) +
  labs(
    title = "Relation entre Classe DPE et Isolation des Murs",
    x = "Étiquette DPE",
    y = "Proportion"
  ) +
  theme_minimal()
```

## Analyse du Graphique 4

**Observation :** La corrélation est sans équivoque. Ce graphique montre que les étiquettes DPE sont le reflet direct de la qualité de l'isolation.

**Analyse :** La quasi-totalité des logements classés **F et G** (plus de 90%) ont une isolation des murs jugée "insuffisante". À l'inverse, les logements performants (classés A, B et C) sont composés en grande majorité de murs à isolation "bonne" ou "très bonne".

**Conclusion :** L'isolation est le levier d'action numéro un. Les "passoires thermiques" sont, avant toute autre chose, des logements mal isolés.

---

# Conclusion Générale

Notre analyse comparative entre le Nord (59) et le Sud (66) révèle des différences de performance énergétique significatives, qui s'expliquent par trois facteurs principaux :

1.  **L'âge du parc immobilier :** Les logements **existants** sont le cœur du problème. Le parc existant du Nord est nettement moins performant que celui du Sud (Analyse 2).
2.  **L'énergie de chauffage :** Le Nord est dominé par le **Gaz**, tandis que le Sud utilise davantage **l'Électricité** (Analyse 3).
3.  **L'isolation :** Nous avons démontré une corrélation directe entre une mauvaise étiquette DPE (F ou G) et une **isolation insuffisante des murs** (Analyse 4).

La bonne performance des logements **neufs** dans les deux régions est encourageante et prouve l'efficacité des normes de construction modernes pour garantir la sobriété énergétique.

---

# Guide d'Utilisation de l'Application d'Exploration

En complément de ce rapport statique, GreenTech Solutions met à la disposition d'Enedis une application d'exploration interactive pour une analyse dynamique des données.

## Accès et Connexion

Pour des raisons de confidentialité, l'application est protégée par un mot de passe.

1.  Ouvrez le lien de l'application qui vous a été fourni.
2.  Entrez les identifiants suivants lorsque vous y êtes invité :
    * **Utilisateur :** `Monsieur svp`
    * **Mot de passe :** `mettez une bonne note`

## Fonctionnalités Principales

L'application vous permet de naviguer à travers plusieurs onglets, chacun offrant une vue différente des données.

### Les Filtres
Sur la plupart des onglets, vous trouverez un panneau de **Filtres**. Vous pouvez y sélectionner le **Type DPE** (neuf ou existant) et le **Département** (Nord ou Sud) pour affiner votre analyse. Les graphiques et les chiffres se mettront à jour automatiquement.

### Les Onglets

* **Comparaison Étiquettes :** C'est l'onglet principal. Il vous permet de visualiser la distribution des étiquettes DPE (A-G) et de comparer la performance globale du Nord et du Sud en temps réel.
* **Variables Explicatives :** Cet onglet vous aide à comprendre *pourquoi* les DPE varient. Il montre des graphiques sur les **types de chauffage** les plus utilisés et la **qualité de l'isolation**.
* **Carte DPE :** Un outil d'analyse géographique qui vous permet de voir où se concentrent les logements (passoires ou performants) sur une carte interactive.
* **Données Brutes :** Un tableau qui vous permet de consulter et d'exporter les données que vous avez filtrées.

---

# Documentation Technique

Cette section est destinée à un public technique (votre professeur ou une autre équipe de développeurs) et détaille l'architecture de la livraison complète.

## Documentation du Rapport (R Markdown)

Ce rapport est un document R Markdown **paramétré**. Il est conçu pour être "Knitté" (généré) depuis RStudio.

### Utilisation des Paramètres
L'automatisation demandée est gérée par l'en-tête `params:`. Pour générer un rapport pour un périmètre spécifique :

1.  Ouvrez ce fichier `.Rmd` dans RStudio.
2.  Cliquez sur la flèche ▼ à côté du bouton "Knit".
3.  Choisissez **"Knit with Parameters..."**.
4.  Une fenêtre s'ouvrira, vous permettant de choisir le département.
5.  Cliquez sur "Knit" pour générer le rapport HTML filtré.

## Documentation de l'Application (Shiny)

L'application est une application **Shiny** développée en R. Son objectif est de permettre une exploration dynamique et interactive du jeu de données DPE.

### Architecture de l'Application
L'application suit une architecture Shiny standard (`app.R` monobloc), qui contient à la fois la logique de l'Interface Utilisateur (UI) et la logique du Serveur (Server). Le schéma ci-dessous illustre le flux de données :

```{mermaid}
graph TD;
    subgraph "Navigateur du Client"
        A[Utilisateur]
    end

    subgraph "Serveur RStudio / Shiny"
        B(Application Shiny - app.R)
        E[Fichier CSV<br/>df_nord_sud_COMBINE_COMPLET.csv]
        
        B -- Contient --> C[UI (Interface)<br/>shinydashboard, shinyjs, leafletOutput]
        B -- Contient --> D[Server (Logique)<br/>reactive(), renderPlotly(), renderLeaflet]
    end

    A -- 1. Interagit avec les filtres --> C;
    C -- 2. Envoie les entrées (inputs) --> D;
    E -- 3. Chargé au démarrage --> D;
    D -- 4. Filtre les données et génère les sorties --> G[Graphiques, KPIs, Tableaux];
    G -- 5. Met à jour l'interface --> C;
```

### Bibliothèques R Clés
L'application repose sur un écosystème de packages R :

* **`shiny` & `shinydashboard` :** Pour la structure de base de l'application et la mise en page en tableau de bord.
* **`shinyjs` :** Utilisé pour les interactions dynamiques de l'interface, notamment le changement de thème.
* **`dplyr` & `readr` :** Pour la manipulation et le chargement des données.
* **`ggplot2` & `plotly` :** Pour la génération des graphiques interactifs.
* **`leaflet` & `sf` :** Pour l'affichage de la carte interactive des DPE.
* **`shinyauthr` :** Pour la brique d'authentification (login/mot de passe).

### Gestion des Données
L'application charge le fichier `df_nord_sud_COMBINE_COMPLET.csv` **une seule fois** au démarrage (`app_data <- reactiveVal(df)`). Les filtres n'entraînent pas une relecture du fichier, mais une simple filtration réactive du dataframe en mémoire, garantissant une haute performance.

### Authentification
L'accès est géré par `shinyauthr` avec des mots de passe hachés (via `sodium`).

* **Utilisateur:** `Monsieur svp`
* **Mot de passe:** `mettez une bonne note`


