library(readr)
library(shiny)
library(dplyr)
library(ggplot2)
library(plotly)
library(bslib)
library(lubridate)
library(leaflet)
library(sf)
library(DT)
library(shinydashboard)
library(scales)
library(fontawesome)
library(shinythemes)
library(shinyjs)
library(rsconnect)
library(curl)
library(tibble)
library(shinyauthr)
library(sodium)
library(tidyr)
library(httr)
library(jsonlite)

# Chargement données
data_file <- "df_nord_sud_COMBINE_COMPLET.csv"
min_year_data <- 2021
max_year_data <- 2025
df <- NULL
show_load_error <- FALSE
error_message <- ""

if (file.exists(data_file)) {
  df <- tryCatch({
    readr::read_csv(data_file, show_col_types = FALSE) 
  }, error = function(e){
    error_message <<- paste("Erreur lecture CSV:", e$message) 
    NULL
  })
  
  if (!is.null(df) && is.data.frame(df) && nrow(df) > 0) {
    
    if ("date_reception_dpe" %in% names(df) && !inherits(df$date_reception_dpe, "Date")) {
      df$date_reception_dpe <- tryCatch(as.Date(df$date_reception_dpe), error = function(e) NA)
    }
    if ("code_postal_ban" %in% names(df)) df$code_postal_ban <- as.character(df$code_postal_ban)
    
    if("code_departement_ban" %in% names(df)) {
      df <- df %>%
        mutate(code_departement_ban = as.character(code_departement_ban), 
               code_departement_ban = case_when(
                 code_departement_ban == "59" ~ "59 - Lille (Nord)",
                 code_departement_ban == "66" ~ "66 - Pyrénées Orientales (Sud)",
                 TRUE ~ code_departement_ban
               ))
    }
    
    required_cols <- c("date_reception_dpe", "etiquette_dpe", "code_departement_ban",
                       "type_source", "coordonnee_cartographique_x_ban", "coordonnee_cartographique_y_ban", "conso_5_usages_par_m2_ep", "surface_habitable_logement")
    missing_cols <- required_cols[!required_cols %in% names(df)]
    
    if(length(missing_cols) > 0){
      error_message <- paste("Colonnes manquantes:", paste(missing_cols, collapse=", "))
      show_load_error <- TRUE
      df <- NULL
    } else {
      dpe_levels <- c("A", "B", "C", "D", "E", "F", "G")
      df$etiquette_dpe <- factor(df$etiquette_dpe, levels = dpe_levels, ordered = TRUE)
      if("etiquette_ges" %in% names(df)) df$etiquette_ges <- factor(df$etiquette_ges, levels = dpe_levels, ordered = TRUE)
      
      df$code_departement_ban <- as.factor(df$code_departement_ban)
      df$type_source <- as.factor(df$type_source)
      
      # Conversion Lambert-93 vers WGS84
      df$latitude <- NA_real_
      df$longitude <- NA_real_
      valid_coords <- !is.na(df$coordonnee_cartographique_x_ban) & !is.na(df$coordonnee_cartographique_y_ban) &
        is.finite(df$coordonnee_cartographique_x_ban) & is.finite(df$coordonnee_cartographique_y_ban)
      
      if(sum(valid_coords) > 0) {
        tryCatch({
          sf_data <- st_as_sf(df[valid_coords, ], coords = c("coordonnee_cartographique_x_ban", "coordonnee_cartographique_y_ban"), crs = 2154, remove = FALSE)
          sf_data_wgs84 <- st_transform(sf_data, crs = 4326)
          coords_wgs84 <- st_coordinates(sf_data_wgs84)
          df$latitude[valid_coords] <- coords_wgs84[, "Y"]
          df$longitude[valid_coords] <- coords_wgs84[, "X"]
          df <- df %>% filter(is.finite(latitude) & is.finite(longitude))
        }, error = function(e) {
          df$latitude <- NA_real_
          df$longitude <- NA_real_
        })
      }
      
      valid_dates <- df$date_reception_dpe[!is.na(df$date_reception_dpe)]
      if(length(valid_dates) > 0) {
        min_year_data <- min(year(valid_dates), na.rm=TRUE)
        max_year_data <- max(year(valid_dates), na.rm=TRUE)
      }
      show_load_error <- FALSE
    }
  } else {
    error_message <- paste("Fichier CSV vide:", data_file) 
    show_load_error <- TRUE
    df <- NULL
  }
} else {
  error_message <- paste("Fichier introuvable:", data_file) 
  show_load_error <- TRUE
  df <- NULL
}

# Dataframe vide si erreur
if (show_load_error || is.null(df) || nrow(df) == 0) {
  show_load_error <- TRUE
  df <- data.frame(code_departement_ban=factor(),
                   etiquette_dpe=factor(levels=c("A", "B", "C", "D", "E", "F", "G"), ordered=TRUE),
                   date_reception_dpe=as.Date(character()),
                   latitude=numeric(), longitude=numeric(),
                   type_source = factor(),
                   coordonnee_cartographique_x_ban=numeric(),
                   coordonnee_cartographique_y_ban=numeric(),
                   type_energie_principale_chauffage=character(),
                   qualite_isolation_murs=character(),
                   surface_habitable_logement=numeric(),
                   conso_5_usages_par_m2_ep=numeric(),
                   annee_construction=numeric(),
                   nom_commune_ban=character(),
                   type_batiment=character(),
                   stringsAsFactors = FALSE, check.names = FALSE)
  min_year_data <- 2021
  max_year_data <- 2025
}

type_source_choices <- if(nrow(df) > 0 && "type_source" %in% names(df) && is.factor(df$type_source) && length(levels(droplevels(df$type_source))) > 0) {
  unique_sources <- levels(droplevels(df$type_source))
  stats::setNames(unique_sources, unique_sources)
} else { c("Existant (dpe03)" = "Existant (dpe03)", "Neuf (dpe02)" = "Neuf (dpe02)") }

departement_choices <- if(nrow(df) > 0 && "code_departement_ban" %in% names(df) && is.factor(df$code_departement_ban) && length(levels(droplevels(df$code_departement_ban))) > 0) {
  unique_depts <- levels(droplevels(df$code_departement_ban))
  stats::setNames(unique_depts, paste0(unique_depts))
} else { c("59 - Lille (Nord)"="59 - Lille (Nord)", "66 - Pyrénées Orientales (Sud)"="66 - Pyrénées Orientales (Sud)") } 

etiquette_choices <- if(nrow(df) > 0 && "etiquette_dpe" %in% names(df) && is.factor(df$etiquette_dpe)) {
  levels(df$etiquette_dpe)
} else { c("A", "B", "C", "D", "E", "F", "G") }

numeric_cols <- names(df)[sapply(df, is.numeric) & !(names(df) %in% c("latitude", "longitude", "coordonnee_cartographique_x_ban", "coordonnee_cartographique_y_ban"))]

default_var_1 <- intersect("surface_habitable_logement", numeric_cols)[1]
default_var_2 <- intersect("conso_5_usages_par_m2_ep", numeric_cols)[1]

if (is.na(default_var_1) && length(numeric_cols) > 0) default_var_1 <- numeric_cols[1]
if (is.na(default_var_2) && length(numeric_cols) > 1) default_var_2 <- numeric_cols[2]
if (is.na(default_var_2) && length(numeric_cols) == 1) default_var_2 <- numeric_cols[1]

app_data <- reactiveVal(df)
rm(df) 

# Auth
user_base <- tibble::tibble(
  user = c("Monsieur svp", "user2"),
  password = sapply(c("mettez une bonne note", "pass2"), sodium::password_store),
  permissions = c("admin", "standard"),
  name = c("User One", "User Two")
)

themes_disponibles <- list(
  "Thème Clair" = "skin-blue",
  "Thème Sombre" = "skin-black"
)

ui <- fluidPage(
  shinyjs::useShinyjs(), 
  
  shinyjs::extendShinyjs(text = "
    shinyjs.changeSkin = function(skin) {
        $('body').removeClass(function(index, className) {
            return (className.match(/\\bskin-\\S+/g) || []).join(' ');
        });
        $('body').addClass('skin-' + skin);
    };
  ", functions = c("changeSkin")),
  
  tags$head(
    tags$link(id="theme_css", rel = "stylesheet", type = "text/css", href = "style.css")
  ),
  
  div(class = "pull-right", shinyauthr::logoutUI(id = "logout")),
  if(!show_load_error) {
    shinyauthr::loginUI(id = "login", title = "Connexion - Analyse DPE", 
                        user_title = "Utilisateur", pass_title = "Mot de passe", 
                        login_title = "Se connecter", error_message = "Identifiants incorrects")
  } else {
    h3(paste("Erreur:", error_message), style="color:red; text-align:center; padding-top: 50px;")
  },
  
  shinyjs::hidden(
    div(
      id = "show-page-content",
      dashboardPage(
        skin = "blue",
        dashboardHeader(
          title = tags$span(
            style = "display: block; width: 100%;",
            tags$img(src = "https://www.soignolles14.fr/wp-content/uploads/2019/03/Logo-ENEDIS.png", 
                     height = "40px", style="margin-top: 5px;")
          ),
          tags$li(
            class = "dropdown",
            style = "float: right; margin-right: 15px; padding-top: 10px;",
            selectInput(
              inputId = "theme_selector",
              label = tags$div("Thème:", style = "font-weight: bold; color: white;"),
              choices = names(themes_disponibles),
              selected = "Thème Clair",
              width = "200px"
            )
          )
        ),
        dashboardSidebar(
          sidebarMenu(
            id = "tabs", 
            menuItem("Comparaison Étiquettes", tabName = "etiquettes_dpe", icon = icon("chart-bar")),
            menuItem("Variables Explicatives", tabName = "var_explicatives", icon = icon("lightbulb")),
            menuItem("Carte DPE", tabName = "carte_dpe", icon = icon("map-marked-alt")),
            menuItem("Données Brutes", tabName = "donnees", icon = icon("table")),
            menuItem("Contexte", tabName = "contexte", icon = icon("info-circle"))
          )
        ),
        dashboardBody(
          tabItems(
            tabItem(tabName = "etiquettes_dpe",
                    fluidRow(
                      box(width = 3, solidHeader = TRUE, status = "primary", title = "Filtres",
                          selectInput("type_source_tab1", "Type DPE :",
                                      choices = c("Tous" = "Tous", type_source_choices),
                                      selected = "Tous"),
                          selectInput("departement_tab1", "Département :",
                                      choices = c("Tous" = "Tous", departement_choices),
                                      selected = "Tous"),
                          sliderInput("plage_annee_tab1", "Année(s) :",
                                      min = min_year_data, max = max_year_data, 
                                      value = c(min_year_data, max_year_data),
                                      step = 1, sep = ""),
                          hr(),
                          h4("Statistiques Clés"),
                          valueBoxOutput("kpi_total_logements", width = 12),
                          valueBoxOutput("kpi_passoires", width = 12),
                          valueBoxOutput("kpi_conso_moyenne", width = 12)
                      ),
                      box(width = 9, solidHeader = TRUE, status = "primary", 
                          title = "Distribution des Étiquettes DPE", 
                          plotlyOutput("etiquette_dpe_plot"))
                    ),
                    fluidRow(
                      box(width = 3, solidHeader = TRUE, status = "info", title = "Filtre Évolution",
                          selectInput("choix_etiquette_evol", "Étiquette DPE :",
                                      choices = etiquette_choices, selected="D")
                      ),
                      box(width = 9, solidHeader = TRUE, status = "info", 
                          title = "Évolution Mensuelle", 
                          plotlyOutput("evolution_dpe_plot"))
                    )
            ),
            tabItem(tabName = "var_explicatives",
                    fluidRow(
                      box(width = 3, solidHeader = TRUE, status = "primary", title = "Filtres",
                          selectInput("type_source_tab2", "Type DPE :",
                                      choices = c("Tous" = "Tous", type_source_choices)),
                          selectInput("departement_tab2", "Département :",
                                      choices = c("Tous" = "Tous", departement_choices)),
                          sliderInput("plage_annee_tab2", "Année(s) :",
                                      min = min_year_data, max = max_year_data,
                                      value = c(min_year_data, max_year_data), step = 1, sep = "")
                      ),
                      box(width = 9,
                          fluidRow(box(width = 12, solidHeader = TRUE, status = "warning", 
                                       title = "Top 3 Énergies de Chauffage", 
                                       plotlyOutput("diag_type_energie_plot"))),
                          fluidRow(box(width = 12, solidHeader = TRUE, status = "success", 
                                       title = "Isolation des Murs", 
                                       plotlyOutput("diag_empile_100_murs_plot")))
                      )
                    ),
                    fluidRow(
                      box(width = 12, solidHeader = TRUE, status = "danger", 
                          title = "Corrélation Variables",
                          fluidRow(
                            column(6, selectInput("variable1", "Variable X :",
                                                  choices = numeric_cols, selected = default_var_1)),
                            column(6, selectInput("variable2", "Variable Y :",
                                                  choices = numeric_cols, selected = default_var_2))
                          ),
                          fluidRow(
                            column(6, radioButtons("show_regression", "Régression :",
                                                   choices = c("Afficher", "Masquer"), inline = TRUE)),
                            column(6, checkboxInput("filter_outliers", "Exclure extrêmes", value = FALSE))
                          ),
                          hr(), textOutput("coeff_cor_text"), plotlyOutput("nuage_plot")
                      )
                    )
            ),
            tabItem(tabName = "carte_dpe",
                    fluidRow(
                      box(width = 3, solidHeader = TRUE, status = "primary", title = "Filtres",
                          selectInput("type_source_tab3", "Type DPE :",
                                      choices = c("Tous" = "Tous", type_source_choices)),
                          selectInput("departement_tab3", "Département :",
                                      choices = c("Tous" = "Tous", departement_choices)),
                          sliderInput("plage_annee_tab3", "Année(s) :",
                                      min = min_year_data, max = max_year_data,
                                      value = c(min_year_data, max_year_data), step = 1, sep = ""),
                          selectInput("etiquette_carte", "Étiquette :",
                                      choices = c("Toutes", etiquette_choices))
                      ),
                      box(width = 9, solidHeader = TRUE, status = "primary", 
                          title = "Carte des Logements", 
                          leafletOutput("carte", height = "600px"))
                    )
            ),
            tabItem(tabName = "donnees",
                    fluidRow(
                      box(width = 3, solidHeader = TRUE, status = "primary", title = "Filtres",
                          selectInput("type_source_tab4", "Type DPE :",
                                      choices = c("Tous" = "Tous", type_source_choices)),
                          selectInput("departement_tab4", "Département :",
                                      choices = c("Tous" = "Tous", departement_choices)),
                          sliderInput("plage_annee_tab4", "Année(s) :",
                                      min = min_year_data, max = max_year_data,
                                      value = c(min_year_data, max_year_data), step = 1, sep = ""),
                          actionButton("refresh_data_api", "Rafraîchir API",
                                       icon = icon("sync"), class = "btn-warning"),
                          hr(),
                          downloadButton("download_data", "Exporter CSV")
                      ),
                      box(width = 9, solidHeader = TRUE, status = "primary", 
                          title = "Tableau des Données", 
                          DTOutput("tableau"))
                    )
            ),
            tabItem(tabName = "contexte",
                    fluidRow(
                      box(width = 12, solidHeader = TRUE, status = "info", title = "Contexte",
                          fluidRow(
                            column(8,
                                   h4("Source des Données"),
                                   p("Données ADEME - DPE France métropolitaine"),
                                   tags$ul(
                                     tags$li(tags$b("Existants:"), 
                                             tags$a(href="https://data.ademe.fr/datasets/dpe-france", 
                                                    target="_blank", "dpe03existant")),
                                     tags$li(tags$b("Neufs:"), 
                                             tags$a(href="https://data.ademe.fr/datasets/dpe-logements-neufs-2", 
                                                    target="_blank", "dpe02neuf"))
                                   ),
                                   p("Période:", min_year_data, "-", max_year_data, "| Départements: 59 et 66")
                            ),
                            column(4, tags$img(src="logo-ademe.jpg", width="80%", style="margin-top:20px;"))
                          )
                      )
                    )
            )
          )
        )
      )
    )
  )
)

server <- function(input, output, session) {
  
  credentials <- shinyauthr::loginServer(
    id = "login", data = user_base, user_col = user, pwd_col = password, 
    sodium_hashed = TRUE, log_out = reactive(logout_init())
  )
  logout_init <- shinyauthr::logoutServer(
    id = "logout", active = reactive(credentials()$user_auth)
  )
  
  observe({
    req(exists("app_data"), shiny::is.reactive(app_data))
    if (credentials()$user_auth && !show_load_error) {
      shinyjs::show(id = "show-page-content")
      shinyjs::hide(id = "login")
    } else if (!credentials()$user_auth && !show_load_error) {
      shinyjs::hide(id = "show-page-content")
      shinyjs::show(id = "login")
    } else {
      shinyjs::hide(id = "show-page-content")
    }
  })
  
  observeEvent(input$theme_selector, {
    req(input$theme_selector)
    selected_skin_name <- themes_disponibles[[input$theme_selector]]
    selected_skin_js <- gsub("skin-", "", selected_skin_name)
    shinyjs::js$changeSkin(selected_skin_js)
    showNotification(paste("Thème:", input$theme_selector), type = "message", duration = 2)
  }, ignoreInit = TRUE)
  
  filtered_data_base <- reactive({
    data_base <- app_data()
    req(data_base, nrow(data_base) > 0)
    data_base
  })
  
  common_filters_data <- reactive({
    req(input$tabs) 
    
    if (input$tabs == "etiquettes_dpe") {
      dept <- input$departement_tab1
      type_src <- input$type_source_tab1
      annees <- input$plage_annee_tab1
    } else if (input$tabs == "var_explicatives") {
      dept <- input$departement_tab2
      type_src <- input$type_source_tab2
      annees <- input$plage_annee_tab2
    } else if (input$tabs == "carte_dpe") {
      dept <- input$departement_tab3
      type_src <- input$type_source_tab3
      annees <- input$plage_annee_tab3
    } else if (input$tabs == "donnees") {
      dept <- input$departement_tab4
      type_src <- input$type_source_tab4
      annees <- input$plage_annee_tab4
    } else {
      return(filtered_data_base()) 
    }
    
    data_filtered <- filtered_data_base()
    start_year <- annees[1]
    end_year <- annees[2]
    
    df_filtered <- data_filtered %>% 
      filter(!is.na(date_reception_dpe) & 
               year(date_reception_dpe) >= start_year & 
               year(date_reception_dpe) <= end_year)
    
    if(dept != "Tous") 
      df_filtered <- df_filtered %>% filter(code_departement_ban == dept)
    if(type_src != "Tous") 
      df_filtered <- df_filtered %>% filter(type_source == type_src)
    
    df_filtered
  })
  
  filtered_data_tab1 <- reactive({ common_filters_data() })
  filtered_data_tab2 <- reactive({ common_filters_data() })
  
  filtered_data_tab3 <- reactive({ 
    data_filtered <- common_filters_data()
    data_filtered <- data_filtered %>% filter(is.finite(latitude) & is.finite(longitude))
    if(input$etiquette_carte != "Toutes") 
      data_filtered <- data_filtered %>% filter(etiquette_dpe == input$etiquette_carte)
    data_filtered
  })
  
  filtered_data_tab4 <- reactive({ common_filters_data() })
  
  output$etiquette_dpe_plot <- renderPlotly({
    data_plot <- filtered_data_tab1()
    req(data_plot, nrow(data_plot) > 0)
    
    data_summary <- data_plot %>%
      count(code_departement_ban, etiquette_dpe) %>%
      group_by(code_departement_ban) %>%
      mutate(Proportion = n / sum(n))
    
    dpt_colors <- c("59 - Lille (Nord)" = "#3FA2F6", "66 - Pyrénées Orientales (Sud)" = "#FF7F50")
    
    p <- ggplot(data_summary, aes(x = etiquette_dpe, y = Proportion, fill = code_departement_ban)) +
      geom_bar(stat = "identity", position = "dodge") +
      scale_y_continuous(labels = scales::percent) +
      scale_fill_manual(values = dpt_colors, name = "Département") +
      labs(title = "Distribution DPE", x = "Étiquette", y = "Pourcentage")
    
    ggplotly(p)
  })
  
  output$kpi_total_logements <- renderValueBox({
    data_kpi <- filtered_data_tab1()
    req(data_kpi) 
    total <- format(nrow(data_kpi), big.mark = " ")
    valueBox(total, "Logements", icon = icon("home"), color = "blue")
  })
  
  output$kpi_passoires <- renderValueBox({
    data_kpi <- filtered_data_tab1()
    req(data_kpi, nrow(data_kpi) > 0)
    passoires <- data_kpi %>% filter(etiquette_dpe %in% c("F", "G")) %>% nrow()
    perc <- if(nrow(data_kpi) > 0) round((passoires / nrow(data_kpi)) * 100, 1) else 0
    valueBox(paste0(perc, "%"), "Passoires", icon = icon("fire"), color = "red")
  })
  
  output$kpi_conso_moyenne <- renderValueBox({
    data_kpi <- filtered_data_tab1()
    req(data_kpi, nrow(data_kpi) > 0, "conso_5_usages_par_m2_ep" %in% names(data_kpi))
    conso <- mean(data_kpi$conso_5_usages_par_m2_ep, na.rm = TRUE)
    valueBox(paste(round(conso, 0), "kWh/m²"), "Conso moyenne", icon = icon("bolt"), color = "yellow")
  })
  
  output$evolution_dpe_plot <- renderPlotly({
    req(input$choix_etiquette_evol)
    data_plot_base <- filtered_data_tab1()
    req(data_plot_base, nrow(data_plot_base) > 0)
    
    if (!input$choix_etiquette_evol %in% unique(data_plot_base$etiquette_dpe)) {
      return(plotly_empty() %>% layout(title = paste("Aucune donnée pour", input$choix_etiquette_evol)))
    }
    
    data_plot <- data_plot_base %>% 
      filter(etiquette_dpe == input$choix_etiquette_evol) %>% 
      mutate(Mois = floor_date(date_reception_dpe, "month")) %>%
      count(code_departement_ban, type_source, Mois, name = "Effectif") %>% 
      ungroup()
    
    if(nrow(data_plot) == 0) return(plotly_empty() %>% layout(title = "Aucune donnée"))
    
    all_months <- seq.Date(
      min(floor_date(data_plot_base$date_reception_dpe, "month"), na.rm=TRUE),
      max(floor_date(data_plot_base$date_reception_dpe, "month"), na.rm=TRUE), 
      by="month"
    )
    
    data_plot <- data_plot %>% 
      tidyr::complete(Mois = all_months, nesting(code_departement_ban, type_source), 
                      fill = list(Effectif = 0)) %>%
      mutate(Groupe = paste0(code_departement_ban, " - ", gsub(" \\(.*", "", type_source)))
    
    p <- ggplot(data_plot, aes(x = Mois, y = Effectif, color = Groupe, group = Groupe,
                               text = paste("Groupe:", Groupe, "<br>Mois:", format(Mois, "%Y-%m"), 
                                            "<br>N:", Effectif))) +
      geom_line(size = 1) + geom_point(size = 1.5) +
      scale_color_manual(values = c("59 - Lille (Nord) - Existant" = "#3FA2F6",
                                    "66 - Pyrénées Orientales (Sud) - Existant" = "#FF7F50",
                                    "59 - Lille (Nord) - Neuf" = "#1E90FF",
                                    "66 - Pyrénées Orientales (Sud) - Neuf" = "#FF6347"),
                         name = "Groupe") +
      labs(title = paste("Évolution", input$choix_etiquette_evol), x = "Date", y = "Nb DPE") +
      theme_minimal(base_size = 10) +
      theme(plot.title = element_text(hjust = 0.5, face = "bold"), legend.position = "bottom")
    
    ggplotly(p, tooltip = "text") %>% layout(legend = list(orientation = "h", x = 0.1, y = -0.2))
  })
  
  output$diag_type_energie_plot <- renderPlotly({
    data_plot <- filtered_data_tab2()
    req(data_plot, nrow(data_plot) > 0, "type_energie_principale_chauffage" %in% names(data_plot))
    
    data_plot <- data_plot %>% 
      filter(!is.na(type_energie_principale_chauffage) & type_energie_principale_chauffage != "") %>%
